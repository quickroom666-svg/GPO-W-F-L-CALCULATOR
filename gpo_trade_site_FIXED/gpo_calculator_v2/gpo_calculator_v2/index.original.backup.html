<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPO Trade — Grid Calculator (W / F / L)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --panel2:#0b1327;
    --border:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#ffd54a; --good:#22c55e; --warn:#facc15; --bad:#ef4444;
    --slot:#0b1327; --slotPlus:#34d399; --radius:14px;
  }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(1000px 600px at 50% 0%,#111827 0,#0b1220 60%);color:var(--text)}
  .wrap{max-width:1200px;margin:20px auto;padding:0 14px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  header h1{font-size:20px;margin:0}
  header .badge{padding:4px 8px;border-radius:999px;background:rgba(255,213,74,.12);color:#fde68a;border:1px solid rgba(255,213,74,.4);font-size:12px}

  .boards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .panel h2{font-size:14px;margin:0 0 8px;display:flex;justify-content:space-between;align-items:center;color:#cbd5e1}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .slot{aspect-ratio:1/1;border:1px dashed #243042;border-radius:10px;background:var(--slot);display:grid;place-items:center;position:relative;overflow:hidden;cursor:pointer}
  .slot .plus{font-size:26px;color:var(--slotPlus);opacity:.9}
  .slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.95}
  .slot .qty{position:absolute;bottom:6px;right:6px;background:#111827;color:#fff;padding:2px 6px;border-radius:999px;border:1px solid #374151;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.45)}

  .slot .name-label{
    position:absolute;left:6px;top:6px;
    padding:2px 6px;border-radius:8px;
    font-size:12px;font-weight:700;line-height:1;
    color:#ffffff;background:rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.12);
    text-shadow:
      -1px -1px 0 #000,
       1px -1px 0 #000,
      -1px  1px 0 #000,
       1px  1px 0 #000,
       0   -2px 0 #000,
       2px   0  0 #000,
       0    2px 0 #000,
      -2px   0  0 #000;
    max-width:70%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }

  .slot .remove{position:absolute;top:6px;right:6px;background:#111827;color:#ef4444;border:1px solid #374151;border-radius:999px;font-size:12px;padding:2px 6px;display:none}
  .slot.filled .remove{display:block}

  .sum{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);color:#cbd5e1}
  .total{font-weight:700;color:var(--accent)}

  .verdict{margin-top:16px;padding:10px 12px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;gap:10px;background:var(--panel2)}
  .verdict.good{border-color:var(--good);color:var(--good);background:rgba(34,197,94,.08)}
  .verdict.fair{border-color:var(--warn);color:var(--warn);background:rgba(250,204,21,.08)}
  .verdict.bad{border-color:var(--bad);color:var(--bad);background:rgba(239,68,68,.08)}

  .tools{margin-top:16px;display:flex;flex-wrap:wrap;gap:8px}
  button,.btn{appearance:none;border:1px solid #334155;background:#0b1327;color:#e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
  button:hover{filter:brightness(1.08)}

  /* Picker modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
  .modal .card{width:min(800px,95vw);background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
  .row{display:flex;gap:8px;align-items:center}
  .row input, .row select{background:#0b1327;border:1px solid #243042;color:#fff;border-radius:10px;padding:8px}
  .row input[type="number"]{width:100px}
  .list{max-height:320px;overflow:auto;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .item{display:flex;gap:8px;align-items:center;border:1px solid #243042;background:#0b1327;border-radius:10px;padding:6px;cursor:pointer}
  .item img{width:46px;height:46px;border-radius:8px;object-fit:cover}
  .muted{color:var(--muted)}
  .note{font-size:12px;color:#93a0b4}
  .hidden{display:none}
  @media (max-width: 900px){ .boards{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>GPO Trade — Grid Calculator</h1>
      <span class="badge">W / F / L</span>
    </header>

    <div class="boards">
      <div class="panel" id="leftPanel">
        <h2>Your Offer <small class="muted">you give</small></h2>
        <div class="grid" id="leftGrid"></div>
        <div class="sum">Your total: <span class="total" id="leftTotal">0</span></div>
      </div>

      <div class="panel" id="rightPanel">
        <h2>Their Offer <small class="muted">you receive</small></h2>
        <div class="grid" id="rightGrid"></div>
        <div class="sum">Their total: <span class="total" id="rightTotal">0</span></div>
      </div>
    </div>

    <div class="verdict fair" id="verdictBox">
      <b id="verdictText">F — FAIR</b>
      <span id="diffText" class="muted">Difference: 0</span>
    </div>

    <div class="tools">
      <button id="clearBtn" class="adminOnly">Clear</button>
      <button id="saveBtn" class="adminOnly">Save Trade</button>
      <button id="loadBtn" class="adminOnly">Load Trade</button>
      <button id="exportBtn" class="adminOnly">Export Catalog</button>
      <label class="btn adminOnly">
        Import Catalog <input type="file" id="importCatalog" accept="application/json" class="hidden">
      </label>
      <label class="btn adminOnly">
        Upload Image (override) <input type="file" id="uploadImg" accept="image/*" class="hidden">
      </label>
    </div>

    <p class="note">Public build is read‑only. Open with <b>?admin=1</b> to show admin tools. Changes are local; use <b>Export Catalog</b> and redeploy to make them permanent.</p>
  </div>

  <!-- Item picker modal -->
  <div class="modal" id="picker">
    <div class="card">
      <div class="row">
        <input id="search" placeholder="Search item by name..." style="flex:1">
        <label>Qty <input id="qty" type="number" min="1" value="1"></label>
        <button id="pickClose">Close</button>
      </div>
      <div class="list" id="itemList"></div>
    </div>
  </div>

<script>
const ENABLE_ADMIN = new URLSearchParams(location.search).get('admin') === '1';

const LEFT_SLOTS = 9, RIGHT_SLOTS = 9;
const STORAGE_KEY = "gpoTradeGridV1";
const IMG_OVERRIDES = "gpoImgOverridesV1"; // name -> dataURL

const state = {
  catalog: { items: [] },
  left: Array(LEFT_SLOTS).fill(null),  // {name, qty}
  right: Array(RIGHT_SLOTS).fill(null),
  picking: { side: "left", index: 0 }
};

function $(q){ return document.querySelector(q) }
function $$ (q){ return Array.from(document.querySelectorAll(q)) }

function abbreviate(n){
  if (n >= 1_000_000) return (n/1_000_000).toFixed(2).replace(/\.00$/,"")+"M";
  if (n >= 1_000) return (n/1_000).toFixed(2).replace(/\.00$/,"")+"k";
  return String(n);
}

async function loadCatalog(){
  try{
    const res = await fetch("catalog.json?_="+Date.now());
    const data = await res.json();
    state.catalog = data;
  }catch(e){
    console.warn("catalog.json not found, using empty catalog");
    state.catalog = {items:[]};
  }
  renderPickerList();
}

function getImgFor(name, fallback){
  // Public read-only: only server catalog images.
  // Admin: allow local overrides (not permanent)
  if (ENABLE_ADMIN){
    const overrides = JSON.parse(localStorage.getItem(IMG_OVERRIDES)||"{}");
    if (overrides[name]) return overrides[name];
  }
  const item = state.catalog.items.find(x=>x.name===name);
  return item?.img || fallback;
}

function slotTemplate(item){
  if (!item) return `<div class="plus">+</div>`;
  const img = getImgFor(item.name, "assets/placeholder.png");
  return `<img src="${img}" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.onerror=null;this.src='assets/placeholder.png'" alt=""><div class="name-label">${item.name}</div><div class="qty">x${item.qty}</div><button class="remove">x</button>`;
}

function buildGrid(el, side){
  el.innerHTML = "";
  const count = side==="left"?LEFT_SLOTS:RIGHT_SLOTS;
  for (let i=0;i<count;i++){
    const data = side==="left"?state.left[i]:state.right[i];
    const slot = document.createElement("div");
    slot.className = "slot"+(data?" filled":"");
    slot.innerHTML = slotTemplate(data);
    slot.onclick = (ev)=>{
      if (ev.target.classList.contains("remove")){
        setSlot(side, i, null);
        return;
      }
      openPicker(side,i,data?.qty||1);
    };
    el.appendChild(slot);
  }
}

function setSlot(side, index, payload){
  if (side==="left") state.left[index]=payload;
  else state.right[index]=payload;
  saveState();
  render();
}

function valueOf(name){
  const it = state.catalog.items.find(x=>x.name===name);
  return it? it.value : 0;
}

function totals(){
  const left = state.left.reduce((a,s)=> s? a + valueOf(s.name)*s.qty : a, 0);
  const right = state.right.reduce((a,s)=> s? a + valueOf(s.name)*s.qty : a, 0);
  return {left,right};
}

function renderVerdict(){
  const box = $("#verdictBox"), text=$("#verdictText"), diff=$("#diffText");
  const t = totals();
  const d = t.right - t.left;
  diff.textContent = "Difference: " + abbreviate(d);
  box.classList.remove("good","fair","bad");
  const margin = 0.05;
  if (t.right >= t.left*(1+margin)){ box.classList.add("good"); text.textContent="W — WORTH"; }
  else if (t.left >= t.right*(1+margin)){ box.classList.add("bad"); text.textContent="L — LOSE"; }
  else { box.classList.add("fair"); text.textContent="F — FAIR"; }
  $("#leftTotal").textContent = abbreviate(t.left);
  $("#rightTotal").textContent = abbreviate(t.right);
}

function render(){
  buildGrid($("#leftGrid"),"left");
  buildGrid($("#rightGrid"),"right");
  renderVerdict();
}

function saveState(){
  const save = {left:state.left,right:state.right};
  if (ENABLE_ADMIN){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(save));
  }
}

function loadState(){
  if (!ENABLE_ADMIN) return;
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw){
    try{
      const data = JSON.parse(raw);
      state.left = Array.isArray(data.left)? data.left : state.left;
      state.right = Array.isArray(data.right)? data.right : state.right;
    }catch(e){}
  }
}

function openPicker(side, index, qty=1){
  state.picking = {side,index};
  $("#picker").style.display="flex";
  $("#qty").value = qty;
  $("#search").value = "";
  renderPickerList();
  $("#search").focus();
}

function closePicker(){ $("#picker").style.display="none" }

function renderPickerList(){
  const list = $("#itemList");
  if (!list) return;
  const q = ($("#search")?.value||"").toLowerCase();
  const items = (state.catalog.items||[]).filter(it=> it.name.toLowerCase().includes(q));
  list.innerHTML = "";
  items.forEach(it=>{
    const el = document.createElement("div");
    el.className="item";
    const img = getImgFor(it.name, it.img||"assets/placeholder.png");
    el.innerHTML = `<img src="${img}" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.onerror=null;this.src='assets/placeholder.png'"><div><div>${it.name}</div><div class="muted">${abbreviate(it.value)}</div></div>`;
    el.onclick = ()=>{
      const qty = Math.max(1, parseInt($("#qty").value||"1",10));
      setSlot(state.picking.side, state.picking.index, {name:it.name, qty});
      closePicker();
    };
    list.appendChild(el);
  });
}

// Admin tools visibility
document.addEventListener("DOMContentLoaded", ()=>{
  document.querySelectorAll('.adminOnly').forEach(el=>{
    if(!ENABLE_ADMIN) el.style.display = 'none';
  });
});

$("#pickClose").onclick = closePicker;
$("#search").oninput = renderPickerList;

$("#clearBtn").onclick = ()=>{ state.left.fill(null); state.right.fill(null); saveState(); render(); }
$("#saveBtn").onclick = ()=>{ saveState(); alert("Saved in this browser."); }
$("#loadBtn").onclick = ()=>{ loadState(); render(); }

$("#exportBtn").onclick = ()=>{
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.catalog,null,2));
  const a = document.createElement("a");
  a.href = dataStr; a.download = "catalog.json";
  document.body.appendChild(a); a.click(); a.remove();
};

$("#importCatalog").onchange = (ev)=>{
  if (!ENABLE_ADMIN) return;
  const f = ev.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      state.catalog = JSON.parse(r.result);
      renderPickerList(); render();
      alert("Catalog imported. Export and redeploy to make permanent.");
    }catch(e){ alert("Invalid catalog.json"); }
  };
  r.readAsText(f);
};

$("#uploadImg").onchange = (ev)=>{
  if (!ENABLE_ADMIN) return;
  const f = ev.target.files[0]; if (!f) return;
  const name = prompt("Image override for which item name? (must match exactly)");
  if (!name) return;
  const r = new FileReader();
  r.onload = ()=>{
    const overrides = JSON.parse(localStorage.getItem(IMG_OVERRIDES)||"{}");
    overrides[name] = r.result; // data URL
    localStorage.setItem(IMG_OVERRIDES, JSON.stringify(overrides));
    render();
    alert("Image saved in this browser. Export catalog + host images for permanent changes.");
  };
  r.readAsDataURL(f);
};

// Init
loadState();
loadCatalog().then(render);
</script>
</body>
</html>
